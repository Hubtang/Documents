<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
<!ENTITY % BOOK_ENTITIES SYSTEM "administrator-guide.ent">
%BOOK_ENTITIES;
]>
<chapter id="chap-Documents-administrator-guide-Chapter-utilites">
	<title>实用工具</title>
	<section id="sect-Documents-administrator-guide-Chapter-utilites_Section_1">
		<title>&OVIRT;&MANAGER;重命名工具</title>
        <section id=
            "sect-Documents-administrator-guide-Chapter-utilites_Section_1_1">
            <title>关于&OVIRT;&MANAGER;重命名工具</title>
            <para>在初始环境下运行engine-setup命令，会根据安装过程中提供的fqdn域
                名生成一系列证书和密钥。如果后期需要修改&MANAGER;的fqdn域名（例
                如，将&MANAGER;迁移到另一个网络环境），需要使用
                ovirt-engine-rename命令完成所有相关的调整。
            </para>
        </section>
        <section id=
            "sect-Documents-administrator-guide-Chapter-utilites_Section_1_2">
            <title>使用&OVIRT;&MANAGER;重命名工具</title>
            <simplesect>
                <title>说明：</title>
                <para>使用ovirt-engine-rename命令更新&MANAGER;的fqdn域名记录。
                </para>
                <procedure>
                    <title>&OVIRT;&MANAGER;重命名</title>
                    <step>
                        <para>在DNS系统中准备好&MANAGER;新的fqdn域名记录以及其他
                            相关记录。
                        </para>
                    </step>
                    <step>
                        <para>如果使用DHCP，修改DHCP配置。
                        </para>
                    </step>
                    <step>
                        <para>修改&MANAGER;服务器的主机名。
                        </para>
                    </step>
                    <step>
                        <para>执行下面的命令：
<screen># /usr/share/ovirt-engine/setup/bin/ovirt-engine-rename
</screen>
                        </para>
                    </step>
                    <step>
                        <para>出现下面的提示时，按下回车键，关闭&MANAGER;：
<screen>During execution engine service will be stopped (OK, Cancel) [OK]:
</screen>
                        </para>
                    </step>
                    <step>
                        <para>出现下面的提示时，输入新的fqdn域名：
<screen>New fully qualified server name:[new name]
</screen>
                        </para>
                    </step>
                </procedure>
                <note>
                    <para>ovirt-engine-rename支持--name参数，参数后面直接指定
                        &MANAGER;新的fqdn域名，可以省去后面提示输入域名的步骤，
                        如：
<screen># /usr/share/ovirt-engine/setup/bin/ovirt-engine-rename \
--name=[new name]
</screen>
                    </para>
                </note>
            </simplesect>
            <simplesect>
                <title>预期结果：</title>
                <para>ovirt-engine-rename会修改以下文件关联的&MANAGER;域名：
                    <itemizedlist>
                        <listitem><simpara>
                                /etc/ovirt-engine/engine.conf.d/10-setup-protocols.conf
                        </simpara></listitem>
                        <listitem><simpara>
                                /etc/ovirt-engine/imageuploader.conf.d/10-engine-setup.conf
                        </simpara></listitem>
                        <listitem><simpara>
                                /etc/ovirt-engine/isouploader.conf.d/10-engine-setup.conf
                        </simpara></listitem>
                        <listitem><simpara>
                                /etc/ovirt-engine/logcollector.conf.d/10-engine-setup.conf
                        </simpara></listitem>
                        <listitem><simpara>
                                /etc/pki/ovirt-engine/cert.conf
                        </simpara></listitem>
                        <listitem><simpara>
                                /etc/pki/ovirt-engine/cert.template
                        </simpara></listitem>
                        <listitem><simpara>
                                /etc/pki/ovirt-engine/certs/apache.cer
                        </simpara></listitem>
                        <listitem><simpara>
                                /etc/pki/ovirt-engine/keys/apache.key.nopass
                        </simpara></listitem>
                        <listitem><simpara>
                                /etc/pki/ovirt-engine/keys/apache.p12
                        </simpara></listitem>
                    </itemizedlist>
                </para>
            </simplesect>
        </section>
	</section>
	
    <section id="sect-Documents-administrator-guide-Chapter-utilites_Section_2">
        <title>&OVIRT;域管理工具</title>
        <section id=
            "sect-Documents-administrator-guide-Chapter-utilites_Section_2_1">
            <title>关于&OVIRT;域管理工具</title>
            <para>&OVIRT;虚拟化环境使用目录服务对于用户进行管理和验证。要在
                &OVIRT;虚拟化环境中添加用户，首先通过admin@internal用户为
                &MANAGER;配置目录服务。添加、删除目录服务时使用
                engine-manage-domains命令。
            </para>
            <para>只有&OVIRT;&MANAGER;服务器上安装了engine-manage-domains命令，
                该命令必须由root用户执行。
            </para>
        </section>

        <section id=
            "sect-Documents-administrator-guide-Chapter-utilites_Section_2_2">
            <title>&OVIRT;域管理工具的命令行说明</title>
            <para>命令的使用方法如下：
                <synopsis>
                    engine-manage-domains -action=ACTION [options]
                </synopsis>
                可用的操作（ACTION）有：
                <variablelist>
                    <varlistentry>
                        <term>add</term>
                        <listitem>
                            <para>为&OVIRT;&MANAGER;添加目录服务。
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>edit</term>
                        <listitem>
                            <para>编辑&OVIRT;&MANAGER;中的目录服务。
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>delete</term>
                        <listitem>
                            <para>为&OVIRT;&MANAGER;删除目录服务。
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>validate</term>
                        <listitem>
                            <para>验证&OVIRT;&MANAGER;中的目录服务。该操作会使用
                                之前配置的用户和密码对所有目录服务进行验证尝试。
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>list</term>
                        <listitem>
                            <para>列出&OVIRT;&MANAGER;中的目录服务。
                            </para>
                        </listitem>
                    </varlistentry>
                </variablelist>
                其他的命令行选项要配合操作一同使用：
                <variablelist>
                    <varlistentry>
                        <term>-domain=DOMAIN</term>
                        <listitem>
                            <para>制定要进行操作的域。对于add、edit和delete操作
                                -domain是必须指定的。
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>-provider=PROVIDER</term>
                        <listitem>
                            <para>指定目录服务的类型，支持的目录服务有：
                                <itemizedlist>
                                    <listitem>
                                        <para>ActiveDirectory - Active Directory
                                        </para>
                                    </listitem>
                                    <listitem>
                                        <para>IPA - Identity Management（IdM）
                                        </para>
                                    </listitem>
                                    <listitem>
                                        <para>RHDS - Red Hat Directory Service。
                                            RHDS不使用Kerberos，而&OVIRT;虚拟化
                                            环境要求使用Kerberos，因此使用RHDS时
                                            需要配置Kerberos域中的一个目录服务。
                                            <note>
                                                <para>使用RHDS时必须安装memberof
                                                    插件，使用memeberof插件要求
                                                    用户都是inetuser用户。
                                                </para>
                                            </note>
                                        </para>
                                    </listitem>
                                </itemizedlist>
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>-user=USER</term>
                        <listitem>
                            <para>指定目录服务的用户。在add操作中-user选项是必需
                                的，edit操作则可以不会指定。
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>-passwordFile=FILE</term>
                        <listitem>
                            <para>指定密码文件，目录服务用户的密码在该文件的第一
                                行。执行add操作时，-passwordFile或者-interactive
                                选项必须使用其中一个。
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>-addPermissions</term>
                        <listitem>
                            <para>为指定的域用户赋予在&OVIRT;&MANAGER;中的
                                SuperUser角色。默认的情况下，没有启用这一选项，
                                指定的域用户不会获得SuperUser的角色。在add和edit
                                操作中可以选择使用-addPermissions选项。
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>-interactive</term>
                        <listitem>
                            <para>指定域用户的密码是否手动（交互式）地提供。在
                                add操作中，该选项和-passwordFile必须选择其中一个
                                使用。
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>-configFile=FILE</term>
                        <listitem>
                            <para>指定命令配置文件的路径。不使用默认配置文件时，
                                使用该选项。
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>-report</term>
                        <listitem>
                            <para>该选项和validate操作一起使用时，会生成在验证过
                                程发生的所有错误信息的报告。
                            </para>
                        </listitem>
                    </varlistentry>
                </variablelist>
            </para>
            <para>engine-manage-domains使用方法的完整说明也可以通过下面的命令获
                取：
                <screen># engine-manage-domains --help
                </screen>
            </para>
        </section>

        <section id=
            "sect-Documents-administrator-guide-Chapter-utilites_Section_2_3">
            <title>使用&OVIRT;域管理工具</title>
            <para>后面几小节通过实际的例子对于&OVIRT;域管理工具的使用方法进行了
                说明。
            </para>
        </section>

        <section id=
            "sect-Documents-administrator-guide-Chapter-utilites_Section_2_4">
            <title>添加目录服务</title>
            <para>本例中，engine-manage-domains将IdM域demo.eayunos.eayun.com添加
                到&OVIRT;&MANAGER;中。使用的用户是eayunos，密码是手动提供的。
                <example>
                    <title>engine-manage-domains的add操作</title>
<screen>
# engine-manage-domains -action=add -domain=demo.eayunos.eayun.com \
-provider=IPA -user=eayunos -interactive
loaded template kr5.conf file
setting default_tkt_enctypes
setting realms
setting domain realm
success
User guid is: 6d580ef5-130a-4931-bcd0-23bd23028ece
Successfully added domain demo.eayunos.eayun.com. oVirt Engine restart is
required in order for the changes to take place (service ovirt-engine restart).
</screen>
                </example>
            </para>
        </section>

        <section id=
            "sect-Documents-administrator-guide-Chapter-utilites_Section_2_5">
            <title>修改目录服务</title>
            <para>本例中，engine-manage-domains对IdM域demo.eayunos.eayun.com的配
                置进行了更改。更改完成之后，&OVIRT;&MANAGER;查询目录服务时使用新
                的用户eayunos。命令执行时密码手动提供。
                <example>
                    <title>engine-manage-domains的edit操作</title>
<screen>
# engine-manage-domains -action=edit -domain=demo.eayunos.eayun.com \
-provider=IPA -user=eayunos -interactive
loaded template kr5.conf file
setting default_tkt_enctypes
setting realms
setting domain realm
success
User guid is: 6d580ef5-130a-4931-bcd0-23bd23028ece
Successfully added domain demo.eayunos.eayun.com. oVirt Engine restart is
required in order for the changes to take place (service ovirt-engine restart).
</screen>
                </example>
            </para>
        </section>

        <section id=
            "sect-Documents-administrator-guide-Chapter-utilites_Section_2_6">
            <title>删除目录服务</title>
            <para>本例中，engine-manage-domains从&OVIRT;&MANAGER;中删除IdM域
                demo.eayunos.eayun.com的配置。更改完成之后，&OVIRT;&MANAGER;中属
                于demo.eayunos.eayun.com的用户将无法登录，但是依然会保留在用户列
                表中，除非手动清理用户列表。
            </para>
            <para>本例中要删除的目录服务是&OVIRT;&MANAGER;中最后一个，所以命令执
                行过程中会给出一个警告，提醒用户最后一个目录服务删除之后，只有
                admin@internal用户可以登录到&MANAGER;，新的用户只能在添加新的目
                录服务之后手动添加。
                <example>
                    <title>engine-manage-domains的delete操作</title>
<screen>
# engine-manage-domains -action=delete -domain=demo.eayunos.eayun.com
WARNING: Domain directory.demo.redhat.com is the last domain in the
configuration. After deleting it you will have to either add another domain, or
to use the internal admin user in order to login.
Successfully deleted domain demo.eayunos.eayun.com. Please remove all users
and groups of this domain using the Administration portal or the API.
</screen>
                </example>
            </para>
        </section>

        <section id=
            "sect-Documents-administrator-guide-Chapter-utilites_Section_2_7">
            <title>验证目录服务</title>
            <para>本例中，engine-manage-domains对&OVIRT;&MANAGER;中的目录服务进
                行验证。验证方法是根据配置文件中每一个目录服务的验证信息进行登录
                尝试，如果成功登录则说明目录服务可用。
                <example>
                    <title>engine-manage-domains的validate操作</title>
<screen>
# engine-manage-domains -action=validate
Domain eayunos.eayun.com is valid.
The configured user for domain eayunos.eayun.com is eayunos@EAYUNOS.EAYUN.COM
Manage Domains completed successfully
</screen>
                </example>
            </para>
        </section>

        <section id=
            "sect-Documents-administrator-guide-Chapter-utilites_Section_2_8">
            <title>列出所有目录服务</title>
            <para>本例中，engine-manage-domains会列出&OVIRT;&MANAGER;中所有目录
                服务。命令结果会列出域名称，域用户（UPN，User Principal Name格
                式）。
                <example>
                    <title>engine-manage-domains的list操作</title>
<screen>
# engine-manage-domains -action=list
Domain: eayunos.eayun.com
    User name: eayunos@EAYUNOS.EAYUN.COM
    Manage Domains completed successfully
</screen>
                </example>
            </para>
        </section>
    </section>

</chapter>

