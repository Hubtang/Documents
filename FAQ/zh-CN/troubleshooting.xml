<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<qandaset defaultlabel="number">
  <qandaentry>
    <question>
      <para>
        eayun ovirt 的基本组件有哪些, 版本号分别是什么?
      </para>
    </question>
    <answer>
      <para>基本的组件有以下:</para>
      <para>基本系统: centos 6.5</para>
      <para>ovirt engine 版本: 3.3.1</para>
      <para>vdsm: 4.13</para>
      <para>kernel: 2.6.32-431</para>
      <para>qemu-kvm: 0.12.1.2-2.415</para>
    </answer>
  </qandaentry>

  <qandaentry>
    <question>
      <para>
        在管理端添加主机失败怎么办?
      </para>
    </question>
    <answer>
      <para>如果是在中文环境下, 请把语言切换到英文环境再添加, 如果还失败, 请联系客服人员</para>
    </answer>
  </qandaentry>

  <qandaentry>
    <question>
      <para>
        如果浏览器不能访问了怎么办?
      </para>
    </question>
    <answer>
      <para>用 ssh 登录到 ovirt engine, 查看一下 /etc/sysconfig/iptables 文件的开头是否如下:</para>
      <para># Generated by ovirt-engine installer</para>
      <para>如果给文件开头不是这样的内容, 或者是如下内容:</para>
      <para># oVirt default firewall configuration. Automatically generated by vdsm bootstrap script.</para>
      <para>请修改 /etc/sysconfig/iptables, 内容参考<ulink url="https://gist.github.com/mathslinux/9224947">这里</ulink>, 然后重启 iptables:</para>
      <programlisting language="Bash">
# service iptables restart
      </programlisting>
      <para>如果问题还存在, 请关闭 iptables:</para>
      <programlisting language="Bash">
# service iptables stop
      </programlisting>
      <para>并联系客服人员</para>
    </answer>
  </qandaentry>

  <qandaentry>
    <question>
      <para>
        把一台 manager 也配置为 node 节点, 重启后管理界面访问不了, 怎么修复?
      </para>
    </question>
    <answer>
      <para>这是因为 node 的防火墙规则覆盖了 manager 的防火墙规则, 导致 http/https 端口被阻拦了, 只要 add host 的时候不要勾选"设置防火墙"选项就没有该问题</para>
    </answer>
  </qandaentry>

  <qandaentry>
    <question>
      <para>
        add host 的时候失败怎么办?
      </para>
    </question>
    <answer>
      <para>首先, 请确保 host 的 ssh 服务是开启的, 如果没有开启, add host 是不会成功的</para>
    </answer>
  </qandaentry>

  <qandaentry>
    <question>
      <para>
        为什么在管理界面的虚拟机页面上不能显示虚拟机的 IP 地址和安装的应用程序?
      </para>
    </question>
    <answer>
      <para>管理端获取虚拟机的 IP 地址等信息是通过虚拟机里面的一个叫 "OVirt Guest Agent" 的代理程序实现的, 请先安装这个程序, 具体的安装信息如下:
      <itemizedlist>
        <listitem>
          <para>如果虚拟机系统是 ubuntu:
          </para>
        </listitem>
      </itemizedlist>
      <programlisting language="Bash">
# wget https://launchpad.net/~zhshzhou/+archive/vdsm-ubuntu/+files/ovirt-guest-agent_1.0.8.201309301944.gitb7f8f2-1ppa1_all.deb
# dpkg -i ovirt-guest-agent_1.0.8.201309301944.gitb7f8f2-1ppa1_all.deb
# apt-get -f install
      </programlisting>

      <itemizedlist>
        <listitem>
          <para>如果虚拟机系统是 centos/fedora:
          </para>
        </listitem>
      </itemizedlist>
      <programlisting language="Bash">
# yum install http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
# yum install -y ovirt-guest-agent
      </programlisting>

      <itemizedlist>
        <listitem>
          <para>如果虚拟机系统是 windows:
          </para>
        </listitem>
      </itemizedlist>
      请按照 <ulink url="http://www.ovirt.org/OVirt_Guest_Agent_For_Windows">这个页面</ulink> 安装 agent, 或者联系易云的客服人员提供安装包
      </para>
    </answer>
  </qandaentry>

  <qandaentry>
    <question>
      <para>
        为什么在管理界面上关机需要点击两次才能关机?
      </para>
    </question>
    <answer>
      <para>从管理界面关机的原理是这样的, 第一次关机的时候, 会向虚拟机代理程序发送一个关机的指令, 如果虚拟机没有安装代理程序, 那么这次指令发送就失败, 当你第二次点击关机按钮的时候, 虚拟机管理程序会直接发送电源关闭事件, 类似于在你的 pc 机器上按按强制关闭按钮, 所以, 为了方便的管理你的虚拟机, 建议你在虚拟机里面安装 "Ovirt Guest Agent", 安装细节参照上一条说明</para>
    </answer>
  </qandaentry>

  <qandaentry>
    <question>
      <para>
        为什么我的虚拟机上网速度很慢, 比主机慢很多?
      </para>
    </question>
    <answer>
      <para>你在创建虚拟机的时候应该 virtio 的网卡, 如果是 windows 系统, 还需要安装 virtio 网卡的驱动, 这样你的上网速度就会飞快了</para>
    </answer>
  </qandaentry>

  <qandaentry>
    <question>
      <para>
        为什么我的虚拟机的硬盘速度比主机的慢很多, 拷贝文件很慢?
      </para>
    </question>
    <answer>
      <para>你在创建虚拟机的时候应该 virtio 磁盘, 如果是 windows 系统, 还需要安装 virtio 磁盘的驱动, virtio 的设备(网卡, 磁盘)是特别为虚拟化开发的硬件技术, 使用这类设备之后, 体验会提高很多</para>
    </answer>
  </qandaentry>
  <qandaentry>
    <question>
      <para>创建虚拟机安装操作系统，系统重启以后会自动又一次进入系统安装盘怎么办？      
      </para>
    </question>
    <answer>
      <para>创建虚拟机时在基础信息设置里面只设置名称、操作系统、内存、CPU及磁盘大小，选择 run once 方式运行虚拟机安装操作系统，系统安装后重启不会再进入系统安装盘</para>
    </answer>
  </qandaentry>
  <qandaentry>
    <question>
      <para>创建某些Windows虚拟机，安装Windows操作系统时，找不到硬盘怎么办？
      </para>
    </question>
    <answer>
      <para>创建Windows系统的虚拟机时，安装过程需要进行两次changeCD</para>
      <para>第一次：run once 运行虚拟机进入虚拟机后，开始安装操作系统，此时登录虚拟化管理平台界面changeCD 选择驱动，再回到虚拟机安装界面加载驱动</para>
      <para>第二次：添加完驱动后，刷新界面可以看到安装的磁盘，此时回到虚拟机管理平台界面上changeCD 选择安装iso文件，回到虚拟机安装界面继续安装</para>
    </answer>
  </qandaentry>
  <qandaentry>
    <question>
      <para>将主机切换到其它数据中心操作有时被禁用，是为什么？
      </para>
    </question>
    <answer>
      <para>主机切换数据中心具体操作如下：</para>
      <para>登录管理系统，在左侧树形面板点击Expand All->System,在右侧详细面板菜单中点击Host,在Host列表下选择要变更数据中心的host,将其变为维护模式,点击edit重新选择数据中心</para>
    </answer>
  </qandaentry>
  <qandaentry>
    <question>
      <para>安装完engine（Host并没有重新安装）,系统已经添加存储域后，重新cleanup再setup系统或重新安装系统，原存储域添加不进来，虚拟机状态不正常，发生这种情况怎么办？
      </para>
    </question>
    <answer>
      <para>重启所有的host即可</para>
    </answer>
</qandaentry>
<qandaentry>
    <question>
        <para>
            创建Win8（Win8 64）类型的虚拟机，设置Console为SPICE，完成创建后通过Console连接虚拟机时会失败，这是什么原因？
        </para>
    </question>
    <answer>
        <para>
            SPICE目前不支持Windows8系统的虚拟机，如果创建Windows8系统的虚拟机配置使用SPICE协议，连接虚拟机时会自动使用RDP连接虚拟机。
        </para>
    </answer>
</qandaentry>
<qandaentry>
    <question>
        <para>
            虚拟机导入导出时，如果同时导入导出多个虚拟机，只能成功一个。
        </para>
    </question>
    <answer>
        <para>
            目前该功能建议不要使用批量的导入导出。
        </para>
    </answer>
</qandaentry>
  <qandaentry>
    <question>
      <para>
       更改所有的主机IP地址，需要做那些事情，可以正确恢复？（以NFS数据存储域为例）
      </para>
    </question>
    <answer>
      <para>
       <orderedlist>
          <listitem>
            <para>
             更改管理网络的IP地址。
            </para>
          </listitem>
          <listitem>
            <para>
             更改DNS服务或者/etc/hosts，确认生效。
            </para>
          </listitem>
          <listitem>
            <para>
             在管理门户中修改管理网络。
            </para>
          </listitem>
       </orderedlist>
     </para>
     <important>
        <para>
         在添加NFS存储域的时候一定要使用FQDN！
        </para>
     </important>
    </answer>
  </qandaentry>
  <qandaentry>
    <question>
      <para>
        我在节点上往管理端进行注册，但在管理端却没有看到等待批准主机加入的信息，为什么？
      </para>
    </question>
    <answer>
      <para>
        <itemizedlist>
          <listitem>
            <para>
              首先，请确认节点与管理端之间是否能够正常连通。
            </para>
          </listitem>
          <listitem>
            <para>
              其次，节点上访问管理端所用的网络设备是否是一个网卡绑定设备。目前并不支持通过网卡绑定设备向管理端进行注册，请先将节点上的网卡绑定移除后再进行向管理端的注册操作。如果您确实需要进行网卡绑定，请在注册完成，节点加入到管理端之后再从管理员门户进行网卡绑定的操作。
            </para>
          </listitem>
        </itemizedlist>
      </para>
     <note>
        <para>
          我们推荐您使用管理员门户中主机标签下的<emphasis>新建</emphasis>按钮进行主机的添加，这种方式不仅支持普通的 EayunOS 节点，也支持安装了相关软件包的 Fedora/Centos 等系统，另外，这种方式还能够添加已经进行过网卡绑定操作的主机以解决您上面遇到的问题。我们并不推荐您使用节点上的向管理端注册的功能，该功能的存在更多的只是由于需要与以前的版本兼容之类的历史原因，我们并不保证该方式在以后的版本中仍然能够被支持。
        </para>
     </note>
    </answer>
  </qandaentry>

  <qandaentry>
      <question>
          <para>
              使用All in One光盘安装时如何配置网络？
          </para>
      </question>
      <answer>
          <para>
              使用All in One光盘3种自动安装时，不会提示进行网络配置，安装完成之
              后，手动进行配置网络。
          </para>
          <para>
              如果希望在安装过程中配置网络，可以在安装菜单选中其中一个自动安装选
              项之后，按<keysym>Tab</keysym>键对引导参数进行编辑，在最后加上空格
              以及“asknetwork”。安装开始之前会提示进行网络配置（字符模式的TUI配
              置界面）。
          </para>
      </answer>
  </qandaentry>

  <qandaentry>
      <question>
          <para>
              All in One光盘安装完成之后，要既作为管理中心使用，也可以充当宿主
              机，防火墙配置如何配置？
          </para>
      </question>
      <answer>
          <para>
              All in One光盘安装完成之后，如果需要配置为宿主机，在管理门户手动添
              加主机时，不要选中“自动配置主机防火墙”。添加成功之后，可以按照
              <emphasis>《EayunOS安装手册》</emphasis>中
              <emphasis>“防火墙配置”</emphasis>章节的说明修改防火墙配置。
          </para>
          <para>
              防火墙配置规则示例（针对既作为管理中心和虚拟机宿主机的服务器，一般
              最少应该满足示例中的配置，其他规则根据实际情况添加）：
              <screen>
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -i lo -j ACCEPT
-A INPUT -p icmp -m icmp --icmp-type any -j ACCEPT
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p tcp --dport 54321 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 5432 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 443 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 6100 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 111 -j ACCEPT
-A INPUT -p udp -m state --state NEW -m udp --dport 111 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 662 -j ACCEPT
-A INPUT -p udp -m state --state NEW -m udp --dport 662 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 875 -j ACCEPT
-A INPUT -p udp -m state --state NEW -m udp --dport 875 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 892 -j ACCEPT
-A INPUT -p udp -m state --state NEW -m udp --dport 892 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 2049 -j ACCEPT
-A INPUT -p udp -m state --state NEW -m udp --dport 32769 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 32803 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 80 -j ACCEPT
# vdsm
-A INPUT -p tcp --dport 54321 -j ACCEPT
# libvirt tls
-A INPUT -p tcp --dport 16514 -j ACCEPT
# guest consoles
-A INPUT -p tcp -m multiport --dports 5634:6166 -j ACCEPT
# migration
-A INPUT -p tcp -m multiport --dports 49152:49216 -j ACCEPT
# snmp
-A INPUT -p udp --dport 161 -j ACCEPT
# Reject any other input traffic
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -m physdev ! --physdev-is-bridged -j REJECT --reject-with icmp-host-prohibited
#drop all rule
-A INPUT -j REJECT --reject-with icmp-host-prohibited
COMMIT
              </screen>
              <important>
                  <para>
                      上述防火墙配置中关于端口的部分，都只针对使用默认参数安装的
                      情况，如果安装过程中或者手动调整了某些服务的端口配置，则需
                      要根据实际情况调整。
                  </para>
              </important>
              <important>
                  <para>
                      请参考《EayunOS安装手册》中“防火墙配置”章节。
                  </para>
              </important>
          </para>
      </answer>
  </qandaentry>
  <qandaentry>
      <question>
          <para>
              Windows操作系统的机器上安装SPICE插件后，登录到EayunOS虚拟机化管理系统，连接系统内的虚拟机时，会失败，提示“Unable to connect to libvirt with URI 【none】”，该怎么办？
          </para>
      </question>
      <answer>
          <para>
              这种情况是因为打开方式选用的是“virt-viewer”，应该采用“Remote-Viewer”方式打开就不会存在这个问题了。
          </para>
      </answer>
  </qandaentry>
  <qandaentry>
      <question>
          <para>
              安装EayunOS管理端时，engine-setup时设置的默认ISO存储域，在系统中不能附加到除本地数据中心以外的其它数据中心下？
          </para>
      </question>
      <answer>
          <para>
              engine-setup时配置的默认ISO存储域的输出地址是域名的形式，如果其它数据中心中的主机不能解析这个域名的话就无法附加，解决办法是配置DNS服务或手动设置/etc/hosts文件。
          </para>
      </answer>
  </qandaentry>
  <qandaentry>
      <question>
          <para>
              如何保证更改EayunOS管理中心和虚拟化宿主机服务器IP地址之后，整个EayunOS虚拟化环境仍然能正常工作？
          </para>
      </question>
      <answer>
          <para>需要根据部署环境分为是否使用本地存储2种情况：</para>
          <procedure>
              <title>没有使用本地存储</title>
              <step>
                  <para>
                      在EayunOS管理中心web门户中，将数据中心中所有的存储域、主机设置为“维护模式”；
                  </para>
              </step>
              <step>
                  <para>
                      修改EayunOS管理中心的IP地址，EayunOS虚拟化宿主机的IP地址，以及其他服务器IP地址（如存储服务器）。各服务器上的/etc/hosts也需要相应进行修改；
                  </para>
              </step>
              <step>
                  <para>
                      如果存储域所在的服务器IP地址也发生变化，修改存储域属性中的IP地址信息，使用EayunOS管理中心提供的REST API接口，如:
                      <example>
                          <title>获取管理中心所有的存储域的连接信息</title>
                          <screen><![CDATA[# curl -k -u admin@internal https://10.0.0.1/api/storageconnections/
Enter host password for user 'admin@internal':
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<storage_connections>
    <storage_connection href="/api/storageconnections/1ffec567-4399-45d5-b1bb-631b4fb36cbe" id="1ffec567-4399-45d5-b1bb-631b4fb36cbe">
        <address>engine-a</address>
        <type>nfs</type>
        <path>/var/lib/exports/iso</path>
    </storage_connection>
    <storage_connection href="/api/storageconnections/2b89a474-d346-4f34-b61f-929a0e66cbf7" id="2b89a474-d346-4f34-b61f-929a0e66cbf7">
        <address>10.0.0.2</address>
        <type>nfs</type>
        <path>/backup/isos</path>
    </storage_connection>
    <storage_connection href="/api/storageconnections/8e18312f-5deb-4e6e-9d10-70f1d3431265" id="8e18312f-5deb-4e6e-9d10-70f1d3431265">
        <address>10.0.0.3</address>
        <type>nfs</type>
        <path>/backup/exports</path>
    </storage_connection>
    <storage_connection href="/api/storageconnections/f87ed61b-5362-41c4-a1f1-beaf866fbf3f" id="f87ed61b-5362-41c4-a1f1-beaf866fbf3f">
        <address>10.0.0.4</address>
        <type>iscsi</type>
        <port>3260</port>
        <target>iqn.2014-07.com.eayun:01:d75b8174-1b93-ecfc-94d8-87b71fc029d0</target>
    </storage_connection>
</storage_connections>
                        ]]></screen>
                      </example>
                      <example>
                          <title>修改指定存储域</title>
                          <para>
                              假设存储域为iSCSI存储，UUID为f87ed61b-5362-41c4-a1f1-beaf866fbf3f，将iSCSI服务器的IP地址修改为10.0.0.5：
                              <screen><![CDATA[# curl -k -u admin@internal -H "Content-Type: application/xml" -X POST https://10.0.0.1/api/storageconnections/f87ed61b-5362-41c4-a1f1-beaf866fbf3f -d "<storage_connection><address>10.0.0.5</address></storage_connection>"</address></storage_connection>
                              ]]></screen>
                          </para>
                      </example>
                  </para>
              </step>
              <step>
                  <para>
                      虚拟化宿主机的IP地址发生变化时，直接将管理中心的主机删除，重新添加主机即可。
                  </para>
              </step>
              <step>
                  <para>
                      在EayunOS管理中心web门户中重新激活存储域等资源。
                  </para>
              </step>
          </procedure>
          <procedure>
              <title>使用本地存储</title>
              <warning><para>
                  本地存储由于无法删除主机重新添加，因此必须强行修改EayunOS管理中心数据库来完成操作，一般不建议进行操作，操作请谨慎。
              </para></warning>
              <step>
                  <para>
                      在EayunOS管理中心web门户中，将数据中心中所有的存储域、主机设置为“维护模式”；
                  </para>
              </step>
              <step>
                  <para>
                      修改EayunOS管理中心的IP地址、/etc/hosts；
                  </para>
              </step>
              <step>
                  <para>
                      修改EayunOS虚拟化宿主机的IP地址、/etc/hosts，这一步除了修改ifcfg-ovirtmgmt（管理逻辑网络对应的网桥设备的配置文件，默认为ovirtmgmt，下同）之外，还需要修改/etc/sysconfig/network-scripts/route-ovirtmgmt，将其中的涉及到的服务器原来的IP地址也修改为新的IP地址；
                  </para>
              </step>
              <step>
                  <para>
                      在eayunos管理中心服务器上，找到数据库中关于虚拟化宿主机（在这里假设为 node-test）的 id：
                      <example>
                          <title>查询虚拟化宿主机相关信息</title>
                          <screen># sudo -u postgres psql
postgres=# \c engine
engine=# select vds_id from vds_static where vds_name = 'node-test';
vds_id                
--------------------------------------
ba44f6c0-d05d-47ee-bc87-9cb9d9b7e1f2
(1 row)
                          </screen>
                      </example>
                  </para>
              </step>
              <step>
                  <para>
                      在EayunOS管理中心服务器上，修改数据库中关于虚拟化属主机的IP地址信息：
                      <example>
                          <title>修改数据库</title>
                          <para>
                              假设新的IP地址为10.0.0.10，主机对应的UUID为ba44f6c0-d05d-47ee-bc87-9cb9d9b7e1f2，逻辑网络对应的U    UID为6e7f8e1b-23ea-4275-a3e7-13741961e347
                              <screen># sudo -u postgres psql
postgres=# \c engine
engine=# UPDATE vds_static SET host_name = '10.0.0.10' where vds_id = 'ba44f6c0-d05d-47ee-bc87-9cb9d9b7e1f2';
engine=# UPDATE vds_interface SET addr = '10.0.0.10' where id = '6e7f8e1b-23ea-4275-a3e7-13741961e347';
                              </screen> 
                          </para>
                      </example>
                  </para>
              </step>
              <step>
                  <para>
                      修改完成，确认无误之后，重启EayunOS管理中心
                      <screen># service ovirt-engine restart
                      </screen>
                  </para>
              </step>
              <step>
                  <para>
                      在EayunOS管理中心web门户中重新激活主机、存储域等资源。
                  </para>
              </step>
          </procedure>
      </answer>
  </qandaentry>
</qandaset>
